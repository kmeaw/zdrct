# ЗДРСТ

Программа для кидания монстров на лицо стримера.

[Demo gif](https://real.kmeaw.com/zdrct.gif)

# Поддерживаемые окружения

* Windows (64-битные версии для Intel/AMD)
* GNU/Linux (i686, x86_64)

Должны работать все движки на базе ZDoom: сам ZDoom, GZDoom, Zandronum.

# Как работает?

zdrct подключается к Twitch и ZDoom. Когда в Twitch происходит событие, оно обрабатывается с помощью скрипта, который может вызывать консольные команды ZDoom.

События бывают трёх типов - чат-команды (в чат канала кто-то пишет сообщение, которое начинается на '!'), нажатия кнопок (если на канале нет баллов канала, то можно подключить альтернативный интерфейс с кнопками) и траты наград (кто-то тратит баллы канала на награду).

Скрипт пишется на языке [Anko](https://github.com/mattn/anko/tree/master/_example/scripts). Чат-команды представлены в скрипте функциями вида cmd_xxxx, которая будет вызвата, если кто-то напишет в чате !xxxx. Функциям можно передавать аргуметы - так сообщение "!hello world 1234" приведёт к вызову cmd_hello("world", "1234").

Вызывать консольные команды можно с помощью функции rcon.

Для алертов надо использовать встроенный в OBS браузер, в котором открыть страницу http://localhost:8666/alerts

# Как использовать?

Если у вас Windows, скачайте и запустите установщик. Пользователи GNU/Linux обычно достаточно подготовлены, чтобы быть способными собрать программу из исходников (см. shell.nix для списка зависимостей).

Когда вы запустите zdrct, откроется страничка в браузере с несколькими вкладками.

## Вкладки

### Twitch

Тут надо интегрировать программу с двумя Twitch-аккаунтами - аккаунтом стримера (управляет наградами и владеет каналом) и аккаунтом бота (общается в чате со зрителями). Так что нажмите верхнюю кнопку "connect", а после завершения процедуры откройте в инкогнито-режиме браузера ту же страницу и нажмите на вторую кнопку "connect" - в этот момент на Twitch надо будет залогиниться ботом. В результате будут сгенерированы OAuth-токены, которые запишутся на локальный диск, и второй раз при перезапуске программы эту процедуру не надо будет повторять.

Ещё на этой вкладке есть интерфейс управления наградами - он нужен для отладки.

### Script

После того, как мы подключили программу к Twitch, нажмите кнопку "Start bot" на вкладке "Script" - это скомпилирует скрипт, и бот начнёт обрабатывать события.

### Actors, Buttons and Rewards

Пока пропустим эти вкладки. Они позволяют генерировать описания для акторов, кнопок и наград, и вставлять его в код скрипта.

### Doom exe and args

Укажите путь к исполняемому файлу движка ZDoom, поправьте аргументы, если хотите, и нажмите "Run". Игра запустится в специальном окружении, которое позволяет zdrct вмешиваться в игровой процесс. На Windows появится ещё дополнительное консольное окошко - не пугайтесь, так и задумано.

### RCon

Последняя вкладка подключает zdrct к игре. Ничего не меняйте, и просто нажмите "Set". Надпись "offline" должна смениться надписью "online", а внизу ещё появится тестовая форма. Попробуйте напечатать в неё какую-нибудь консольную команду (например "say hello") и нажмите кнопку "go" - когда окно с игрой снова получит фокус, команда должна будет выполниться.

Если вы успешно завершили все эти шаги, то всё должно работать. Попробуйте написать какую-нибудь команду в чат (начните с "!help") или потратьте баллы канала. Экспериментируйте со скриптом, чтобы сделать свои собственные фичи.

# Краткое описание сущностей встроенного скриптового языка

## Встроенные переменные

### admin
Имя владельца канала

## Функции

### reply(fmt, args...)
Пишет сообщение в чат

### list_cmds()
Возвращает список доступных чат-команд

### from()
Возвращает имя того пользователя, который инициировал действие

### is_reward()
Возвращает true, если действие было инициировано тратой награды в Twitch

### rcon(fmt, args...)
Вызвать команду ZDoom. Возвращает true, если команду удалось доставить и false в противном случае.

### sleep(n)
Спать n секунд. n может быть int64 или float64.

### alert(message[, image[, sound]])
Вывести алерт

### roll(p1, v1, p2, v2, ...)
возвращает v1 с шансом p1, v2 с шансом p2, ...

### set_last(key, delta)
Запоминает момент key, как delta секунд в будущем

### last(key)
Возвращает момент key (или 0, если его не запоминали)

### rate(key, delta)
Возвращает true и запоминает delta секунд в будущем как момент key, если его ранее не запоминали, или он уже прошёл.
Возвращает false, если момент key был запомнен и ещё не прошёл.

### int(s)
Приводит строку s к числовому типу. Возвращает -1, если это невозможно.

### join(elems, sep)
Возвращает строку elems[0] + sep + elems[1] + sep + ... + sep + elems[N-1]

### rand
Возвращает число из полуинтервала [0.0, 1.0).

### randn(n)
Возвращает целое число из полуинтервала [0, n).

### sprintf(fmt, args...)
Возвращает строку, полученную подстановкой args в форматную строку fmt.

### eval(code)
Возвращает результат выполнения кода

### balance(user)
Баланс внутренних баллов пользователя user

### set_balance(user, new_balance)
Поменять баланс пользователя user на new_balance

### tts(str)
Отправить строку в сервис синтеза голоса и проиграть результат.

### system(prog, args...)
Запустить внешнюю программу.

### play(filename)
Проиграть аудио из файла.

## Типы данных

### int64
Целое число

### float64
Вещественное число

### string
Строка - последовательность байт в кодировке UTF-8

### func(...)...
Функция, которая что-то принимает и возвращает

### bool
Булевый тип - true или false

### nil
Нулевой тип, имеет только одно значение - nil

### Command
Кнопка. Содержит поля Cmd, Text, Image - строки.
Cmd - имя чат-функции.
Text - название кнопки.
Image - изображение.

### Actor
Актор ZDoom. Содержит поля ID, AlertImage, AlertSound и Reply - строки.
ID - имя [актора](https://zdoom.org/wiki/Classes)
Name - человекопонятное имя
AlertImage - картинка для алерта
AlertSound - звук для алерта
Reply - сообщение от бота в чат

### Reward
Награда Twitch. Содержит [очень много полей](https://dev.twitch.tv/docs/api/reference#create-custom-rewards)
Самые нужные поля:
Title - название награды, строка;
Cost - стоимость награды, целое положительное число;
IsEnabled - признак включенности награды; булевый тип.

## Специальные функции для управления кнопками и наградами
Эти функции вызываются один раз при старте скрипта. Их нельзя инициировать действиями зрителя.

### add_command(command)
Добавляет кнопку command.

### map_reward(reward, command)
Добавляет награду reward, в момент траты которой будет нажата кнопка command.
