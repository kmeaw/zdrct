# ЗДРСТ

Программа для кидания монстров на лицо стримера.

# Как работает?

zdrct подключается к Twitch и ZDoom. Когда в Twitch происходит событие, оно обрабатывается с помощью скрипта, который может вызывать консольные команды ZDoom.

События бывают трёх типов - чат-команды (в чат канала кто-то пишет сообщение, которое начинается на '!'), нажатия кнопок (если на канале нет баллов канала, то можно подключить альтернативный интерфейс с кнопками) и траты наград (кто-то тратит баллы канала на награду).

Скрипт пишется на языке [Anko](https://github.com/mattn/anko/tree/master/_example/scripts). Чат-команды представлены в скрипте функциями вида cmd_xxxx, которая будет вызвата, если кто-то напишет в чате !xxxx. Функциям можно передавать аргуметы - так сообщение "!hello world 1234" приведёт к вызову cmd_hello("world", "1234").

Вызывать консольные команды можно с помощью функции rcon.

# Краткое описание сущностей встроенного скриптового языка

## Встроенные переменные

### admin
Имя владельца канала

## Функции

### reply(fmt, args...)
Пишет сообщение в чат

### list_cmds()
Возвращает список доступных чат-команд

### from()
Возвращает имя того пользователя, который инициировал действие

### is_reward()
Возвращает true, если действие было инициировано тратой награды в Twitch

### rcon(fmt, args...)
Вызвать команду ZDoom. Возвращает true, если команду удалось доставить и false в противном случае.

### sleep(n)
Спать n секунд. n может быть int64 или float64.

### alert(message[, image[, sound]])
Вывести алерт

### roll(p1, v1, p2, v2, ...)
возвращает v1 с шансом p1, v2 с шансом p2, ...

### set_last(key, delta)
Запоминает момент key, как delta секунд в будущем

### last(key)
Возвращает момент key (или 0, если его не запоминали)

### rate(key, delta)
Возвращает true и запоминает delta секунд в будущем как момент key, если его ранее не запоминали, или он уже прошёл.
Возвращает false, если момент key был запомнен и ещё не прошёл.

### int(s)
Приводит строку s к числовому типу. Возвращает -1, если это невозможно.

### join(elems, sep)
Возвращает строку elems[0] + sep + elems[1] + sep + ... + sep + elems[N-1]

### rand
Возвращает число из полуинтервала [0.0, 1.0).

### randn(n)
Возвращает целое число из полуинтервала [0, n).

### sprintf(fmt, args...)
Возвращает строку, полученную подстановкой args в форматную строку fmt.

### eval(code)
Возвращает результат выполнения кода

### balance(user)
Баланс внутренних баллов пользователя user

### set_balance(user, new_balance)
Поменять баланс пользователя user на new_balance

## Типы данных

### int64
Целое число

### float64
Вещественное число

### string
Строка - последовательность байт в кодировке UTF-8

### func(...)...
Функция, которая что-то принимает и возвращает

### bool
Булевый тип - true или false

### nil
Нулевой тип, имеет только одно значение - nil

### Command
Кнопка. Содержит поля Cmd, Text, Image - строки.
Cmd - имя чат-функции.
Text - название кнопки.
Image - изображение.

### Actor
Актор ZDoom. Содержит поля ID, AlertImage, AlertSound и Reply - строки.
ID - имя [актора](https://zdoom.org/wiki/Classes)
Name - человекопонятное имя
AlertImage - картинка для алерта
AlertSound - звук для алерта
Reply - сообщение от бота в чат

### Reward
Награда Twitch. Содержит [очень много полей](https://dev.twitch.tv/docs/api/reference#create-custom-rewards)
Самые нужные поля:
Title - название награды, строка;
Cost - стоимость награды, целое положительное число;
IsEnabled - признак включенности награды; булевый тип.

## Специальные функции для управления кнопками и наградами
Эти функции вызываются один раз при старте скрипта. Их нельзя инициировать действиями зрителя.

### add_command(command)
Добавляет кнопку command.

### map_reward(reward, command)
Добавляет награду reward, в момент траты которой будет нажата кнопка command.
